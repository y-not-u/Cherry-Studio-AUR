name: Check and update AUR package

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel jq git
      - name: Create build user and setup permissions
        run: |
          useradd -m builduser
          # Get current working directory
          WORKDIR=$(pwd)
          echo "WORKDIR=$WORKDIR" >> $GITHUB_ENV
          
          # Give builduser access to all files including .git
          chown -R builduser:builduser "$WORKDIR"
          # Ensure builduser can read .git directory
          chmod -R g+rwX "$WORKDIR"
      - name: Get latest upstream version
        run: |
          VERSION=$(curl -s https://api.github.com/repos/cherryHQ/cherry-studio/releases/latest | jq -r '.tag_name')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not fetch latest version or version is empty."
            exit 1
          fi
          VERSION=${VERSION#v}
          echo "Latest upstream tag: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Get current version
        run: |
          CURRENT_VERSION=$(grep -oP '^pkgver=\K.*' PKGBUILD)
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Warning: pkgver not found in PKGBUILD. Defaulting to 0.0.0."
            CURRENT_VERSION="0.0.0"
          fi
          echo "Current version: $CURRENT_VERSION"
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
      - name: Compare versions and update if needed
        run: |
          if [ "$CURRENT_VERSION" = "$VERSION" ]; then
            echo "Versions are the same ($CURRENT_VERSION), skipping update"
            exit 0
          else
            echo "Version different (upstream: $VERSION, current: $CURRENT_VERSION), proceeding with update"
          fi
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Error: Upstream version is empty or 'null'. Cannot proceed with update."
            exit 1
          fi
      - name: Update PKGBUILD version (as builduser)
        run: |
          cd "$WORKDIR"
          echo "Updating PKGBUILD to version: $VERSION"
          
          # Switch to builduser for file operations
          su - builduser -c "
            cd '$WORKDIR'
            
            # Update pkgver - use different delimiter to avoid issues with version numbers
            sed -i 's|^pkgver=.*|pkgver=$VERSION|' PKGBUILD
            sed -i 's|^pkgrel=.*|pkgrel=1|' PKGBUILD
            
            # Verify the changes
            echo 'Updated PKGBUILD:'
            grep -E '^(pkgver|pkgrel|pkgname)=' PKGBUILD
          "
      - name: Calculate checksums and generate .SRCINFO (as builduser)
        run: |
          # Ensure builduser owns the files
          chown -R builduser:builduser "$WORKDIR"
          
          # Switch to builduser for makepkg operations
          cd "$WORKDIR"
          su - builduser -c "
            cd '$WORKDIR'
            
            # Download the AppImage first
            curl -L -o 'cherry-studio-\$VERSION.AppImage' 'https://github.com/cherryHQ/cherry-studio/releases/download/v\$VERSION/Cherry-Studio-\$VERSION-x86_64.AppImage'
            
            # Generate checksums using makepkg
            makepkg -g >> PKGBUILD
            
            # Generate .SRCINFO using makepkg
            makepkg --printsrcinfo > .SRCINFO
          "
      - name: Commit changes (as builduser)
        run: |
          cd "$WORKDIR"
          
          # Check if there are changes first
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Commit as builduser with git configuration
          su - builduser -c "
            cd '$WORKDIR'
            
            # Configure git for builduser
            git config --global user.email 'action@github.com'
            git config --global user.name 'GitHub Action Bot'
            
            # Add and commit changes
            git add --all
            git commit -m 'chore: update to $VERSION'
            git push origin \$(git branch --show-current)
          "
      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: cherry-studio-bin
          pkgbuild: ./PKGBUILD
          assets: |
            ./cherry-studio.desktop
            ./cherry-studio.png
            ./cherry-studio-bin.sh
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_KEY }}
          commit_message: Update AUR package
          ssh_keyscan_types: rsa,ecdsa,ed25519
