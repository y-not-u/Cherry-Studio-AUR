name: Check and update AUR package

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get latest upstream version
        run: |
          VERSION=$(curl -s https://api.github.com/repos/cherryHQ/cherry-studio/releases/latest | jq -r '.tag_name')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not fetch latest version or version is empty."
            exit 1
          fi
          VERSION=${VERSION#v}
          echo "Latest upstream tag: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Get current version
        run: |
          CURRENT_VERSION=$(grep -oP '^pkgver=\K.*' PKGBUILD)
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Warning: pkgver not found in PKGBUILD. Defaulting to 0.0.0."
            CURRENT_VERSION="0.0.0"
          fi
          echo "Current version: $CURRENT_VERSION"
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
      - name: Compare versions and update if needed
        run: |
          if [ "$CURRENT_VERSION" = "$VERSION" ]; then
            echo "Versions are the same ($CURRENT_VERSION), skipping update"
            exit 0
          else
            echo "Version different (upstream: $VERSION, current: $CURRENT_VERSION), proceeding with update"
          fi
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Error: Upstream version is empty or 'null'. Cannot proceed with update."
            exit 1
          fi
      - name: Update PKGBUILD version
        uses: heyhusen/archlinux-package-action@v2
        with:
          pkgver: ${{ env.VERSION }}
          pkgrel: 1
          flags: ''
          srcinfo: true
          updpkgsums: false
      - name: Calculate checksums manually
        run: |
          # Download the AppImage first
          curl -L -o "cherry-studio-${{ env.VERSION }}.AppImage" "https://github.com/cherryHQ/cherry-studio/releases/download/v${{ env.VERSION }}/Cherry-Studio-${{ env.VERSION }}-x86_64.AppImage"
          
          # Calculate checksums for local files
          CHECKSUMS=()
          
          # AppImage checksum
          APPIMAGE_CHECKSUM=$(sha256sum "cherry-studio-${{ env.VERSION }}.AppImage" | cut -d' ' -f1)
          CHECKSUMS+=("'$APPIMAGE_CHECKSUM'")
          echo "AppImage checksum: $APPIMAGE_CHECKSUM"
          
          # Desktop file checksum
          DESKTOP_CHECKSUM=$(sha256sum "cherry-studio.desktop" | cut -d' ' -f1)
          CHECKSUMS+=("'$DESKTOP_CHECKSUM'")
          echo "Desktop file checksum: $DESKTOP_CHECKSUM"
          
          # PNG file checksum
          PNG_CHECKSUM=$(sha256sum "cherry-studio.png" | cut -d' ' -f1)
          CHECKSUMS+=("'$PNG_CHECKSUM'")
          echo "PNG file checksum: $PNG_CHECKSUM"
          
          # Shell script checksum
          SH_CHECKSUM=$(sha256sum "cherry-studio-bin.sh" | cut -d' ' -f1)
          CHECKSUMS+=("'$SH_CHECKSUM'")
          echo "Shell script checksum: $SH_CHECKSUM"
          
          # Update PKGBUILD with new checksums
          sed -i "s/sha256sums=('SKIP'/sha256sums=('${APPIMAGE_CHECKSUM}'/" PKGBUILD
          sed -i "s/'SKIP'  # desktop file/'${DESKTOP_CHECKSUM}'  # desktop file/" PKGBUILD
          sed -i "s/'SKIP'  # png file/'${PNG_CHECKSUM}'  # png file/" PKGBUILD
          sed -i "s/'SKIP')  # shell script/'${SH_CHECKSUM}')  # shell script/" PKGBUILD
          
          # Show updated checksums
          echo "Updated checksums:"
          grep -A 4 "sha256sums=" PKGBUILD
          
          # Generate .SRCINFO
          makepkg --printsrcinfo > .SRCINFO
      - name: Commit changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action Bot"
          git add --all
          git commit -m "chore: update to ${{ env.VERSION }}"
          git push origin ${{ github.ref_name }}
      - name: Verify checksums
        run: |
          echo "Verifying that all checksums have been calculated (no SKIP values)"
          if grep -q "'SKIP'" PKGBUILD; then
            echo "Error: Some checksums are still set to 'SKIP'"
            grep "'SKIP'" PKGBUILD
            exit 1
          else
            echo "All checksums have been calculated successfully"
          fi
      - name: Publish AUR package
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: cherry-studio-bin
          pkgbuild: ./PKGBUILD
          assets: |
            ./cherry-studio.desktop
            ./cherry-studio.png
            ./cherry-studio-bin.sh
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_KEY }}
          commit_message: Update AUR package
          ssh_keyscan_types: rsa,ecdsa,ed25519

